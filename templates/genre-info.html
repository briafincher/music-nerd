{% extends 'base.html' %}
{% block content %}

<div id='page'>

    <nav class='categories'>
        <span id='related-title' class='sidebar'>Related Genres</span>
        <span id='artists-title' class='sidebar'>Top Artists</span>
        <span id='features-title' class='sidebar'>Audio Features</span>
        <span id='description-title' class='sidebar'>About the Genre</span>
        <span id='playlist-title' class='sidebar'>Music Nerd Guide</span>
    </nav>

    <div id='main'>

        <section id='genre-section'>
            <div class='main' id='genre'>
                <h1>Let's explore <b>{{ capitalized }}!</b>!</h1>
            </div>
        </section>

        <section id='playlist-section'>
            <div class='main' id='playlist'>
                <p>We've created a playlist to help get you started.</p>
                <p>Click the button below to listen to some <b>{{ genre }}</b> tunes while you learn more. This playlist
                    will be saved to your Spotify library.</p>
                <button id='playlist-button'>Show Music Nerd's Guide to {{ genre }}!</button>
                <iframe id='playlist-iframe' width="300" height="380" frameborder="0" allowtransparency="true" hidden></iframe>
            </div>
        </section>

        <section id='description-section'>
            <div class='main' id='description'>
                {% if description %}
                    <h2>A little about {{ capitalized }}...</h2>
                    <p>{{ description }}</p>
                    <p id='asterisk'>*Some genre names are similar to other Wikipedia pages, so this description
                        might seem strange. We are working on cleaning up our data.</p>
                {% else %}
                    <h2>Aw shucks! It looks like Wikipedia doesn't have much to say about {{ genre }}</h2>
                    <p>That's ok. I bet we can get a still figure out what it's all about.</p>
                {% endif %}
            </div>
        </section>

        <section id='features-section'>

            <div class='main' id='audio-features'>
                <h2>Here's What {{ capitalized }} Sounds Like</h2>
                <p>Let's take a closer look at how we can characterize its tracks</p>
                <div id='feature-names'>
                    <span id='a-label'>Acousticness</span>
                    <meta id='a-value' data-acousticness="{{features['acousticness']}}">

                    <span id='d-label'>Danceability</span>
                    <meta id='d-value' data-danceability="{{features['danceability']}}">

                    <span id='e-label'>Energy</span>
                    <meta id='e-value' data-energy="{{features['energy']}}">

                    <span id='i-label'>Instrumentalness</span>
                    <meta id='i-value' data-instrumentalness="{{features['instrumentalness']}}">

                    <span id='li-label'>Liveness</span>
                    <meta id='li-value' data-liveness="{{features['liveness']}}">

                    <span id='lo-label'>Loudness</span>
                    <meta id='lo-value' data-loudness="{{features['loudness']}}">

                    <span id='s-label'>Speechiness</span>
                    <meta id='s-value' data-speechiness="{{features['speechiness']}}">

                    <span id='t-label'>Tempo</span>
                    <meta id='t-value' data-tempo="{{features['tempo']}}">

                    <span id='v-label'>Valence</span>
                    <meta id='v-value' data-valence="{{features['valence']}}">
                </div>

                <div id='feature-info'>
                    <p id='info'></p>
                </div>
                
                <div id='feature-slider'>
                    <input type='range' id='slider'>
                </div>
                <div id='feature-category'>
                    <span id='low'>Low</span>
                    <span id='medium'>Medium</span>
                    <span id='high'>High</span>
                </div>
            </div>
            <script src='/static/genre_features.js'></script>
        </section>

        <section id='artists-section'>
            <div class='main' id='top-artists'>
                <div id='artists'>
                <h2>These are the most popular artists making {{ genre }} music</h2>
                {% for artist in artists %}
                    <div>{{artist}}<br><img src='{{artists.get(artist)}}'></div>
                {% endfor %}
                </div>
            </div>
        </section>

        <section id='related-section'>
            <div class='main' id='related-genres'>
                <h2>{{ capitalized }} is most closely related to:</h2>
                <p>Click on a genre name to explore that genre!</p>
                <canvas id='ctx' width='600px' height='160px'></canvas>
                <meta id='related-one' data-genre="{{ related[0]['genre'] }}" data-shared="{{ related[0]['shared'] }}" data-upper="{{ related[0]['capitalized'] }}">
                <meta id='related-two' data-genre="{{ related[1]['genre'] }}" data-shared="{{ related[1]['shared'] }}" data-upper="{{ related[1]['capitalized'] }}">
                <meta id='related-three' data-genre="{{ related[2]['genre'] }}" data-shared="{{ related[2]['shared'] }}" data-upper="{{ related[2]['capitalized'] }}">
                <meta id='related-four' data-genre="{{ related[3]['genre'] }}" data-shared="{{ related[3]['shared'] }}" data-upper="{{ related[3]['capitalized'] }}">
                <meta id='related-five' data-genre="{{ related[4]['genre'] }}" data-shared="{{ related[4]['shared'] }}" data-upper="{{ related[4]['capitalized'] }}">


                <script src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.0/Chart.bundle.min.js'></script>
                <script>
                    var ctx = $('#ctx')

                    var one = $('#related-one').data();
                    var two = $('#related-two').data();
                    var three = $('#related-three').data();
                    var four = $('#related-four').data();
                    var five = $('#related-five').data();

                    var allGenres = [one, two, three, four, five];
                    var genres = [];
                    for (var i = 0; i < allGenres.length; i++) {
                        var genre = allGenres[i];
                        if (genre.shared > 0) {
                            genres.push(genre);
                        }
                    }

                    var labelsList = [];
                    var dataList = [];

                    for (var i = 0; i < genres.length; i++) {
                        var genre = genres[i];
                        labelsList.push(genre.upper);
                        dataList.push(genre.shared);
                    }

                    var relatedChart = new Chart(ctx, {
                        type: 'horizontalBar',
                        data: {
                            labels: labelsList,
                            datasets: [{
                                backgroundColor: '#3e95cd',
                                data: dataList
                            }]
                        }, 
                        options: {
                            legend: { display: false },
                            title: { display: false },
                            scales: {
                                xAxes: [{ display: false }]
                            }
                        }
                    });

                    $('#ctx').on('click', function(evt){
            
                        var base = relatedChart.scales['y-axis-0'].right;
                        var height = relatedChart.chart.height;
        
                        if(evt.offsetX < base){

                            var count = relatedChart.scales['y-axis-0'].ticks.length;
                            
                            var bar_height = height / count;
                            var bar_index = Math.floor(evt.offsetY / bar_height);

                            var label = relatedChart.data.labels[bar_index];
                            var genre = label.toLowerCase();

                            $.get('/genres/' + genre, function() {
                                window.location = '/genres/' + genre;
                            });
                        }

                    }); 
                </script>

            </div>
        </section>

    </div>

</div>


<script src="https://code.jquery.com/jquery.js"></script>
<script>
    function renderPlaylist(evt) {
        // AJAX to alert if user not signed in. Make a route to check & return data
        $.get('/playlist/{{genre}}', function(data) {
            $('#playlist-iframe').attr('src', data).show();
            $('#playlist-button').hide();
        });
    }

    $('#playlist-button').on('click', renderPlaylist);
</script>

<script>
    function emphasize(id) {
        $(id).addClass('highlighted')
    }

    function deemphasize(id) {
        $(id).removeClass('highlighted')
    }

    $('#playlist-section').on('scroll', function() { emphasize('#playlist-title'); });
    $('#description-section').on('scroll', function() { emphasize('#description-title'); });
    $('#artists-section').on('scroll', function() { emphasize('#artists-title'); });
    $('#related-section').on('scroll', function() { emphasize('#related-title'); });
    $('#features-section').on('scroll', function() { emphasize('#features-title'); });

    $('#playlist-section').off('scroll', function() { deemphasize('#playlist-title'); });
    $('#description-section').off('scroll', function() { deemphasize('#description-title'); });
    $('#artists-section').off('scroll', function() { deemphasize('#artists-title'); });
    $('#related-section').off('scroll', function() { deemphasize('#related-title'); });
    $('#features-section').off('scroll', function() { deemphasize('#features-title'); });
</script>


{% endblock %}
